---
- name: "Ensure {{ immich_user }} is created"
  ansible.builtin.import_role:
    name: infrastructure/user
  vars:
    user_name: "{{ immich_user }}"
    user_password: "{{ immich_user_password }}"

- name: Ensure immich storage directory location exists
  ansible.builtin.import_role:
    name: infrastructure/service-data-directory
  vars:
    path: "{{ immich_storage_directory }}"
    user: "{{ immich_user }}"
    zfs_encryption_key: "{{ immich_zfs_encryption_key }}"

- name: Ensure immich is running
  become: true
  become_user: "{{ immich_user }}"
  block:
    - name: Ensure immich container network is created
      containers.podman.podman_network:
        name: "{{ immich_network }}"
        driver: bridge
        recreate: false
        state: present

    - import_tasks: immich-database.yaml
    - import_tasks: immich-redis.yaml
    - import_tasks: immich-machine-learning.yaml
    - import_tasks: immich-server.yaml

