---
- name: Ensure firewall is installed
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop:
    - ip6tables
    - iptables
    - awall

- name: Ensure awall policy and traefik configs are available
  ansible.builtin.copy:
    src: "{{ item }}"
    dest: /etc/awall/optional/
  loop:
    - global-policy.json
    - traefik.json

- name: Ensure awall service config and policy are enabled
  community.general.awall:
    name: "{{ item }}"
    state: enabled
  loop:
    - global-policy
    - traefik

- name: Ensure iptables services are started, such that the awall activation will succeed
  ansible.builtin.command: "iptables -L"
  become: true
  become_method: "{{ superuser_method }}"

- name: Ensure ip6tables services are started, such that the awall activation will succeed
  ansible.builtin.command: "ip6tables -L"
  become: true
  become_method: "{{ superuser_method }}"

- name: Ensure awall policies are active
  ansible.builtin.command: "awall activate -f"
  async: 5
  poll: 0
  become: true
  become_method: "{{ superuser_method }}"

- name: Sleep to avoid ssh issues due to the awall policy application
  ansible.builtin.pause:
    seconds: 5

