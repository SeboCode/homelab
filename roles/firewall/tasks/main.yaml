---
- name: Ensure firewall is installed
  ansible.builtin.package:
    name: "{{ item }}"
    state: present
  loop:
    - ip6tables
    - iptables
    - awall

- name: Ensure awall policy is available
  ansible.builtin.copy:
    src: global-policy.json
    dest: /etc/awall/optional/

- name: Ensure awall port redirect config and policy are enabled
  community.general.awall:
    name: global-policy
    state: enabled

- name: Ensure awall policies are well defined
  ansible.builtin.command: "awall translate -o /tmp"

- name: Ensure awall policies are active
  community.general.awall:
    activate: true
  async: 3
  poll: 0
  become: true
  become_method: "{{ superuser_method }}"

- name: Sleep to avoid ssh issues due to the awall policy application
  ansible.builtin.pause:
    seconds: 3

- name: Ensure traffic is redirected from local 80/443 to traefik ports
  ansible.builtin.iptables:
    table: nat
    chain: OUTPUT
    out_interface: lo
    protocol: tcp
    destination_ports: "{{ item.from }}"
    jump: REDIRECT
    to_ports: "{{ item.to }}"
    state: present
  loop:
    - {from: 80, to: "{{ traefik_web_port }}"}
    - {from: 443, to: "{{ traefik_websecure_port }}",}

